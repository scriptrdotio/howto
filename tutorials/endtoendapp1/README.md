# About this tutorial

This is a short tutorial on how to implement a very simple end-to-end IoT application with scriptr.io, as means to start familiarizing yourself with scriptr.io.

We will consider the following use case: we need to display in a very simple dashboard, the current and historical values of measurements (speed, temperature and number of passengers) made by a device that sends these data to our scriptr.io account through http POST requests. Value changes will be reflected in real-time in the dashboard.

Through the tutorial, you will become more familiar with:

- Programming applications with scriptr.io
- Exposing operations through an API
- Storing and persisting data into scriptr.io's NoSQL data store
- Broadcasting messages
- Building a dashboard using scriptr.io's dashboard builder

# The IoT application

## Application parts

Our application will be composed of two parts:
- A data ingestion script used by the device to send measurements. The script saves the data it receives in your scriptr.io account's  NoSQL data store and publishes updates to the dahsboard
- A dahsboard script that receives published data and displays it.

![logical architecture](./sampleapp1_architecture.png)

To keep it simple, we will simulate the device by resorting to [Postman](https://www.getpostman.com/products), a well known http client. We will manually send data from Postman to our data ingestion script. 

## Required functionality

Our application requires the following to be implemented:

1. Extract the payload sent by the device from the received http request
2. Store the extracted payload (measurements) into the NoSQL data store
3. Query the data store for the historical values of each measurement
4. Publish the latest values and the historical values to the dashboard
5. Display the values in the dashboard

# Implementation

## Part 1: the ingestion script

In the following, we assume that the device sends us the following JSON payload via an HTTP POST request:
```
{
  "speed": <some_value>, // e.g. 45
  "temperature": <some_value_in_celsius>, // e.g. 25
  "num_passengers": <some_value> // e.g. 12
}
```

### 1. Extract payload sent by the device

So let's go ahead and create our ingestion script. To create a new script from the [workspace](https://www.scrptr.io/workspace), click on the +New Script option in the bottom-left corner of the screen:

- Enter a name for your script ("ingestion")
- In the editor area, type "return" and save the script by clicking "Save" in the menu bar.

![create_script](./ingestion_script_1.png)

In scriptr.io, any script you implement is automatically turned into a secure web service, remotely accessible via different protocols and notably http. After saving your script. you now have a remotely accessible API available at the following endpoint: https://api.scriptrapps.io/ingest.

You might be wondering what would happen if all readers of this tutorial named their script "ingestion", wouldn't there be collisions? Actually, since scriptr.io turned your script into a **secure** web service (you might have noticed the small red lock on the right), devices can only invoke that script by sending requests along with credentials that are initially generated by your own scriptr.io account. Since credentials are account specific, there is no risk of collision! We'll get back to credentials later on.

Let's now add the code that retrieves the payload from the http request, to the "ingestion" script. All we need is to use the native **request** object and read the payload from the latter's **body** property:
```
var payload = request.body;
```
Save your changes by clicking "Save".

### 2. Store the extracted payload (measurements) into the NoSQL data store

In scriptr.io's NoSQL data store, you save data into *documents*. To manipulate documents, you need the document API. To instruct your script to load the document API, just use the **require** function as follows:
```
var document = require("document"); // add this line to the ingestion script
```
To create a document using the received payload, just save the latter by using the **save** function of the document object.
```
document.save(payload);  // add this line to the ingestion script
```
That's all. Don't forget to save your changes.

### 3. Query the data store for the historical values of each measurement

Scriptr.io queries allow you to retrieve documents from your NoSQL store, based on some criteria you specify. A query requires you to specify the following (at least):
- the query expression (filtering criteria)
- the fields to return from the document

So let's assume we want to obtain all documents that have a non null speed and temperature fields. We will accordingly create a new query object as follows:
```
// add the below to the ingestion script
var queryObj = {
  query: "temperature is not null and speed is not null",
  fields: "temperature, speed, number_passsengers, creationDate"
};
```
**Note**: you might have noticed that the "fields" property contains the "creationDate" field, which is not a field that the device sent. This is part of the metadata that is automatically added by scriptr.io. It indicates the date/time at which a document was created.

Executing queries on documents is also done using the document API, using the **query** function. Since we already loaded the latter in the above lines of code, we can directly reuse our "document" variable:
```
// add the below lines to the ingestion script
var resp = document.query(queryObj); // excute the query
var historicalData = resp.result.documents; // the returned documents list
```
**Note**: scriptr.io automatically limits to 50 the number of documents that are returned by a query.

Don't forget to save your changes.

### 4. Publish the latest and the historical values to the dashboard

Publishing - or broadcasting - data to anyone listening (this is refered to as "publish/subscribe") is done in scriptr.io through **channels**. Therefore, before we can publish anything to our dashboard, we first need to create a channel:

- Click your username in the top-right corner of the screen
- From the drop-down, select "settings"
- Click the "Channel" tab
- Add a new channel (name it "dashboardChannel" for this tutorial) them click the check sign

![create_channel](./ingestion_script_2.png)

**Note** any entity wishing to consume the messages that are published to a channel needs to subscribe to it. You can have one or many subscribers for the same channel.

Let's now get back to editing the "ingestion" script. We need to publish the new data to the dashboard (through the **dashboardChannel**). This is simply done using the native **publish** function that expects you to pass it the following properties:

- "id": this can be any string you specify, which is used by a subsciber of the channel to determine that a published message is his
- "result": this can be any value or object to publish towards subscribers

So let's go ahead and add the code to publish the payload that was just received by our "ingest" script:
```
// add the below line to the ingestion script
publish("id": "latest_device_data", "result": payload);
```
Let's also add the code to publish the historical values we've just obtained from the execution of our request:
```
// add the below line to the ingestion script
publish("id": "historical_device_data", "result": historicalData);
```
Notice that we used different id values: "latest_device_data" and "historical_device_data", which allows the widget of the dashboard to only consume messages they are interested in, as we will see it shortly.

## Part 2: the dashboard

In this simple example, we will not code anything on the User Interface side, but we will rather resort the "Dahboard Builder", a visual tool provide by scriptr.io's web IDE to rapidly implement dashboards. 

To create a new dashboard, simply click the arrow near "+New Script" in the bottom left corner of the [workspace](https://www.scrptr.io/workspace) the select "Dashboard". 

To display current values of speed, temperature and number of passengers, we will respectively use 2 gauges and 1 odometer. Just click the corresponding icon in the dashboard's toolbar to add the widgets to the dashboard.

![create_dashboard](./ingestion_script_3.png)

Let's customize our widgets a bit to fit our use case, by clicking the gear icon on the right corner of each widget. Let's start with the first gauge that will display the latest value of the speed:

- In the DATA tab, replace the value of the **Message tag** with the value specified for the **id** field of the message published to the channel. In our case, we used "latest_device_data"
- In the DATA tab, replace the code in the **Format data** field with the following:
```
return data.speed;
```
**data** contains the value that is received by the widget. Since the ingestion script is publishing the whole payload it received, we need to instruct the gauge widget to only read the value of the payload field it is interested in (the "speed"). This is why we have to replace ```return data``` with ```return data.speed```.

![create_dashboard](./ingestion_script_5.png)

- In the MIN/MAX tab, replace the values of the **Gauge min** and **Gauge max** fields with values you find appropriate to represent the speed (let's say 0 to 150)

